name: Build Libraries

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all platforms'
        required: false
        default: 'false'
        type: boolean

env:
  VCPKG_BINARY_SOURCES: "clear;files,${{ github.workspace }}/vcpkg_cache,readwrite"

jobs:
  build-linux:
    name: Build Linux Libraries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Setup Git LFS
        run: |
          git lfs install
          git lfs pull

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config \
            python3 curl zip unzip tar

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            vcpkg
            vcpkg_installed
            vcpkg_cache
          key: vcpkg-linux-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-linux-

      - name: Setup vcpkg
        run: |
          if [ ! -d "vcpkg" ]; then
            git clone https://github.com/microsoft/vcpkg.git
          fi
          ./vcpkg/bootstrap-vcpkg.sh -disableMetrics

      - name: Install dependencies
        run: |
          ./vcpkg/vcpkg install --triplet=x64-linux \
            --x-manifest-root=. \
            --x-install-root=./vcpkg_installed

      - name: Build libraries
        run: |
          cmake --preset ci-linux \
            -DVCPKG_TARGET_TRIPLET=x64-linux \
            -DVCPKG_INSTALLED_DIR=${{ github.workspace }}/vcpkg_installed
          cmake --build --preset ci-linux

      - name: Verify output
        run: |
          echo "Checking libs/linux directory..."
          ls -la libs/linux/
          echo ""
          echo "Libraries:"
          ls -la libs/linux/lib/*.a | head -20
          echo ""
          echo "Total libraries: $(ls libs/linux/lib/*.a | wc -l)"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libs-linux
          path: libs/linux/
          retention-days: 7

  build-macos:
    name: Build macOS Libraries
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Setup Git LFS
        run: |
          git lfs install
          git lfs pull

      - name: Install system dependencies
        run: |
          brew install cmake ninja pkg-config python3

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            vcpkg
            vcpkg_installed
            vcpkg_cache
          key: vcpkg-macos-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-macos-

      - name: Determine triplet
        id: triplet
        run: |
          if [ "$(uname -m)" = "arm64" ]; then
            echo "triplet=arm64-osx" >> $GITHUB_OUTPUT
            echo "preset=ci-macos-arm64" >> $GITHUB_OUTPUT
          else
            echo "triplet=x64-osx" >> $GITHUB_OUTPUT
            echo "preset=ci-macos" >> $GITHUB_OUTPUT
          fi

      - name: Setup vcpkg
        run: |
          if [ ! -d "vcpkg" ]; then
            git clone https://github.com/microsoft/vcpkg.git
          fi
          ./vcpkg/bootstrap-vcpkg.sh -disableMetrics

      - name: Install dependencies
        run: |
          ./vcpkg/vcpkg install --triplet=${{ steps.triplet.outputs.triplet }} \
            --x-manifest-root=. \
            --x-install-root=./vcpkg_installed

      - name: Build libraries
        run: |
          cmake --preset ${{ steps.triplet.outputs.preset }} \
            -DVCPKG_TARGET_TRIPLET=${{ steps.triplet.outputs.triplet }} \
            -DVCPKG_INSTALLED_DIR=${{ github.workspace }}/vcpkg_installed
          cmake --build --preset ${{ steps.triplet.outputs.preset }}

      - name: Verify output
        run: |
          echo "Checking libs/macos directory..."
          ls -la libs/macos/
          echo ""
          echo "Libraries:"
          ls -la libs/macos/lib/*.a | head -20
          echo ""
          echo "Total libraries: $(ls libs/macos/lib/*.a | wc -l)"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libs-macos
          path: libs/macos/
          retention-days: 7

  build-windows:
    name: Build Windows Libraries
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Setup Git LFS
        run: |
          git lfs install
          git lfs pull

      - name: Remove system LLVM (conflicts with MinGW)
        run: |
          if (Test-Path "C:\Program Files\LLVM") {
            Remove-Item -Recurse -Force "C:\Program Files\LLVM"
          }
        shell: pwsh

      - name: Cache LLVM-MinGW
        id: cache-llvm-mingw
        uses: actions/cache@v4
        with:
          path: C:\llvm-mingw
          key: llvm-mingw-20241217

      - name: Install LLVM-MinGW
        if: steps.cache-llvm-mingw.outputs.cache-hit != 'true'
        run: |
          $url = "https://github.com/mstorsjo/llvm-mingw/releases/download/20241217/llvm-mingw-20241217-ucrt-x86_64.zip"
          $output = "llvm-mingw.zip"
          Invoke-WebRequest -Uri $url -OutFile $output
          Expand-Archive -Path $output -DestinationPath "C:\"
          Rename-Item "C:\llvm-mingw-20241217-ucrt-x86_64" "C:\llvm-mingw"
        shell: pwsh

      - name: Add LLVM-MinGW to PATH
        run: |
          echo "C:\llvm-mingw\bin" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Install build tools
        run: |
          choco install ninja -y

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            vcpkg
            vcpkg_installed
            vcpkg_cache
          key: vcpkg-windows-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-windows-

      - name: Setup vcpkg
        run: |
          if (!(Test-Path "vcpkg")) {
            git clone https://github.com/microsoft/vcpkg.git
          }
          .\vcpkg\bootstrap-vcpkg.bat -disableMetrics
        shell: pwsh

      - name: Install dependencies
        run: |
          .\vcpkg\vcpkg.exe install --triplet=x64-mingw-static `
            --x-manifest-root=. `
            --x-install-root=.\vcpkg_installed
        shell: pwsh

      - name: Build libraries
        run: |
          cmake --preset ci-windows `
            -DVCPKG_TARGET_TRIPLET=x64-mingw-static `
            -DVCPKG_INSTALLED_DIR=${{ github.workspace }}\vcpkg_installed
          cmake --build --preset ci-windows
        shell: pwsh

      - name: Verify output
        run: |
          Write-Host "Checking libs/windows directory..."
          Get-ChildItem libs/windows/
          Write-Host ""
          Write-Host "Libraries:"
          Get-ChildItem libs/windows/lib/*.a | Select-Object -First 20
          Write-Host ""
          Write-Host "Total libraries: $((Get-ChildItem libs/windows/lib/*.a).Count)"
        shell: pwsh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libs-windows
          path: libs/windows/
          retention-days: 7

  commit-artifacts:
    name: Commit Built Libraries
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git LFS
        run: |
          git lfs install

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: libs-linux
          path: libs/linux/

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: libs-macos
          path: libs/macos/

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: libs-windows
          path: libs/windows/

      - name: Display structure
        run: |
          echo "=== Linux ==="
          ls -la libs/linux/lib/*.a | wc -l
          echo ""
          echo "=== macOS ==="
          ls -la libs/macos/lib/*.a | wc -l
          echo ""
          echo "=== Windows ==="
          ls -la libs/windows/lib/*.a | wc -l

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Track new LFS files
        run: |
          # Ensure .a files are tracked by LFS
          git lfs track "libs/**/*.a"
          git lfs track "libs/**/*.lib"
          git add .gitattributes

      - name: Commit and push
        run: |
          git add libs/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update pre-built libraries

          Built from commit: ${{ github.sha }}
          Workflow run: ${{ github.run_id }}

          Platforms:
          - Linux (x64-linux)
          - macOS (x64-osx/arm64-osx)
          - Windows (x64-mingw-static)"

            git push
            echo "Changes committed and pushed"
          fi
